name: Start WireGuard Server

on:
  schedule:
    # Run at 8:00 CET (7:00 UTC in winter, 6:00 UTC in summer)
    # Using 7:00 UTC to match CET winter time
    # Note: Adjust to 6:00 UTC during summer time (CEST)
    - cron: '0 7 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  start-server:
    runs-on: ubuntu-latest
    
    steps:
      - name: Start Selectel VDS Server
        env:
          SELECTEL_API_KEY: ${{ secrets.SELECTEL_API_KEY }}
          SELECTEL_SERVER_ID: ${{ secrets.SELECTEL_SERVER_ID }}
        run: |
          echo "Starting server $SELECTEL_SERVER_ID..."
          
          # Start server using Selectel VScale API
          # API endpoint: https://api.vscale.io/v1/scalets/{SERVER_ID}/start
          response=$(curl -s -w "\n%{http_code}" -X PATCH \
            -H "X-Token: $SELECTEL_API_KEY" \
            -H "Content-Type: application/json;charset=UTF-8" \
            --data-binary "{\"id\":$SELECTEL_SERVER_ID}" \
            "https://api.vscale.io/v1/scalets/$SELECTEL_SERVER_ID/start")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 202 ]; then
            echo "✓ Server start command sent successfully"
            echo "$body"
          else
            echo "✗ Error starting server. HTTP code: $http_code"
            echo "$body"
            exit 1
          fi

      - name: Verify server status
        env:
          SELECTEL_API_KEY: ${{ secrets.SELECTEL_API_KEY }}
          SELECTEL_SERVER_ID: ${{ secrets.SELECTEL_SERVER_ID }}
        run: |
          echo "Waiting for server to start..."
          sleep 10
          
          # Check server status using VScale API
          status=$(curl -s -X GET \
            -H "X-Token: $SELECTEL_API_KEY" \
            "https://api.vscale.io/v1/scalets/$SELECTEL_SERVER_ID" | grep -o '"status":"[^"]*"' | cut -d'"' -f4 || echo "unknown")
          
          echo "Server status: $status"
          
          if [ "$status" = "active" ] || [ "$status" = "running" ] || [ "$status" = "started" ]; then
            echo "✓ Server is running"
          else
            echo "⚠ Server status: $status (may still be starting)"
          fi

